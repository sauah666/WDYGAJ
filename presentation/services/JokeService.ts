
// Layer: PRESENTATION (Service)
// Purpose: Manage dark humor, persistence, and rotation logic.

const STORAGE_KEY = 'sys_seen_jokes_v1';

// --- DATABASE ---

const JOKES_DB: Record<string, string[]> = {
    // SALARY
    'SALARY_BROKE': [
        "На доширак собираем?", "Ты волонтер?", "Маловато будет!", "Это на проездной?", "Скромность - путь к бедности.",
        "Почка еще на месте?", "В переходе больше подают.", "Суп из опилок - это кето.", "На воде долго не протянешь.",
        "Это в час или в месяц?", "Сдачу оставь себе.", "Голодание просветляет.", "Кошки вкусные, если уметь готовить.",
        "А коммуналка оплачена?", "Интернет от соседей воруешь?", "Одежду в секонде на вес берешь?",
        "Зубы лечить не планируешь?", "Пенсия не скоро, не надейся.", "Кредиторы уже звонили?", "Коллекторы твои друзья.",
        "Зато не в деньгах счастье... да?", "С таким запросом только в рабство.", "Галеры ждут гребца.",
        "За еду работаешь?", "Фотосинтез освоил?", "В монастырь не думал уйти?", "Бомжи на районе богаче.",
        "Голубей кормишь или ловишь?", "Это зарплата или чаевые?", "На спички хватит.", "Мыло есть, веревка нужна?",
        "Депозит пустых бутылок надежнее.", "Инвестируешь в макулатуру?", "Смешно. Очень смешно.", "Ты серьезно?",
        "На паперти конкуренция высокая.", "Может, лучше почку продать?", "Кровь сдавать выгоднее.",
        "Это шутка, да?", "Микрозаймы - твой выбор.", "Доширак - пища богов.", "Чайный пакетик на три раза.",
        "Свет не включай, дорого.", "Пешком ходить полезно.", "Зимой в коробке холодно.", "Готовься к земле.",
        "Амбиции как у амебы.", "Нищеброд детекед.", "Стыдно быть бедным.", "Мама знает, что ты нищий?"
    ],
    'SALARY_MEDIOCRE': [
        "Классика жанра.", "На ипотеку хватит (на сарай).", "Не густо, но и не пусто.", "С пивом потянет.", "Обычная зарплата.",
        "Середнячок.", "Как у всех.", "Не рыба, не мясо.", "На жизнь хватит, на похороны - нет.", "Штаны поддержит.",
        "Без изысков.", "На Турцию раз в год накопить можно.", "Машина в кредит, да?", "Квартира в ипотеку на 30 лет.",
        "Стабильность - признак мастерства.", "Звезд с неба не хватаем.", "Сойдет для сельской местности.",
        "Не олигарх, но и не бомж.", "Офисный планктон одобряет.", "Уровень выживания: комфортный.",
        "На бизнес-ланч хватит.", "Пятница - праздник.", "От зарплаты до зарплаты.", "Заначку сделать не выйдет.",
        "Зубы лечить можно, но по одному.", "На такси по праздникам.", "Пиво по акции.", "Одежда из масс-маркета.",
        "Телефон в рассрочку.", "Мечты о даче.", "Серые будни.", "Нормально делай - нормально будет.",
        "Не позорься, проси больше.", "Твоя цена?", "Рыночек порешал.", "Средний класс (почти).",
        "На гречку с мясом хватит.", "Не жируем.", "Скромненько.", "Бухгалтерия не удивится.",
        "Эконом-класс.", "Проездной на метро окупается.", "На черный день не отложишь.", "Тише едешь - дальше будешь.",
        "Золотая середина болота.", "Не взлетим, так поплаваем.", "Уровень: NPC.", "Серая мышь.", "Без амбиций.", "Стандарт."
    ],
    'SALARY_GOOD': [
        "Вот это разговор.", "Уважаю.", "Сеньор в здании.", "Можно откладывать.", "Золотая середина.",
        "На масло хватает, и на икру тоже.", "Ипотеку закроешь досрочно.", "Машину обновишь.", "Уровень жизни: человек.",
        "Наконец-то цифры.", "Приятно глазу.", "Достойно.", "Не стыдно маме сказать.", "Коллеги будут завидовать.",
        "На Бали зимовать можно.", "Стейки каждый день?", "Зубы все на месте?", "ДМС со стоматологией?",
        "Уже лучше.", "Почти элита.", "Средний класс здорового человека.", "Можно и в ресторане поесть.",
        "Такси комфорт-класса.", "Одежда без катышков.", "Отпуск два раза в год.", "Айфон не в кредит.",
        "Инвестиции? Слышал такое слово?", "Финансовая подушка растет.", "Уверенность в завтрашнем дне.",
        "Неплохо для начала.", "Растем.", "Ценный кадр.", "Хедхантеры облизываются.", "Звучит вкусно.",
        "Живем.", "Красиво жить не запретишь.", "Уже не стыдно.", "Нормальный чек.", "Рынок перегрет тобой.",
        "Жир.", "Сливки.", "Буржуй.", "Налоги платить жалко.", "Купишь слона?", "Серьезная заявка.",
        "Не продешевил?", "Торгуйся до конца.", "Знаешь себе цену.", "Профи.", "Топчик."
    ],
    'SALARY_GREEDY': [
        "Губа не дура.", "Ты что, Илон Маск?", "Лопнешь же.", "Налоговая выехала.", "Уровень 'Бог'.",
        "Ты банк грабить собрался?", "За такие деньги нужно уметь летать.", "Скромнее надо быть.", "Ты компанию купить хочешь?",
        "Генеральный директор столько не получает.", "Золотой парашют готовишь?", "Бюджет небольшой страны.",
        "Морда не треснет?", "Куда тебе столько?", "В гробу карманов нет.", "Делиться надо.", "Совесть продал?",
        "Зажрались.", "Олигарх комнатный.", "Буржуй недорезанный.", "Классовый враг.", "Раскулачивать пора.",
        "Ты точно программист, а не наркобарон?", "Деньги не пахнут?", "Жадность - это плохо.", "А работать будешь?",
        "За эти деньги ты должен жить в офисе.", "Душу дьяволу продал?", "Слишком много нулей.", "Глаза разуй.",
        "Рынок в шоке.", "HR в обмороке.", "Бюджет лопнет.", "Ты стоишь как чугунный мост.", "Золотая антилопа.",
        "Денег куры не клюют.", "В ванне с шампанским купаешься?", "Яхту присмотрел?", "Остров покупаешь?",
        "Космос зовет?", "Марс колонизировать собрался?", "Ты не обнаглел?", "Спустись на землю.",
        "Корона потолок не царапает?", "Царь, просто царь.", "Бог маркетинга.", "Гений вымогательства.",
        "Алмазный фонд.", "Золотой телец.", "Мамкин бизнесмен."
    ],

    // LOCATIONS
    'LOC_MOSCOW': [
        "Москва слезам не верит.", "Готов к пробкам?", "МКАД - кольцо всевластия.", "Здесь дорого.",
        "В метро не задавили?", "Понаехали.", "Нерезиновая.", "Квартира стоит как почка.", "Смог и пафос.",
        "Время - деньги, и его нет.", "Бешеная сушка.", "Ритм убийственный.", "Люди злые.", "Метро - подземное царство.",
        "Плитка Собянина.", "Реновация мозга.", "Кремль видишь?", "Сити для понтов.", "Дорого-богато.",
        "Здесь выживают сильнейшие.", "Джунгли из бетона.", "Парковку не найдешь.", "Эвакуатор уже едет.",
        "Штрафы летят.", "Кофе за 500 рублей.", "Таксисты короли.", "Каршеринг для смертников.",
        "Зима серая, лето душное.", "Толпы зомби.", "Все бегут.", "Никто не спит.", "Деньги решают.",
        "Связи решают.", "Власть рядом.", "Центр мира (нет).", "Третье кольцо ада.", "Садовое кольцо страданий.",
        "Чистые пруды, грязные мысли.", "Патрики для мажоров.", "Окраины для выживания.", "Замкадье существует?",
        "Жизнь в ипотеку.", "Успешный успех.", "Москва не Россия.", "Государство в государстве.", "Золотая клетка.",
        "Муравейник.", "Вавилон.", "Рим Третий.", "Хаос."
    ],
    'LOC_SPB': [
        "В Питере пить.", "Соли и парадные.", "Ветер выдует душу.", "Культурная столица.",
        "Расчленинград.", "Болотная жижа.", "Серое небо навсегда.", "Солнце - миф.", "Дождь - состояние души.",
        "Мосты разводят, тебя тоже.", "Эрмитаж головного мозга.", "Интеллигенция в запое.", "Шаверма, не шаурма.",
        "Поребрик, не бордюр.", "Парадная, не подъезд.", "Кура, греча, безысходность.", "Пётр рубил окно, ты рубишь фишку.",
        "Окно в Европу заколочено.", "Сырость и плесень.", "Туберкулез привет.", "Крыши и руферы.",
        "Дворы-колодцы затягивают.", "Достоевщина.", "Раскольников с топором.", "Старушек береги.",
        "Нева глубокая.", "Ветер с залива.", "Балтийский чай.", "Романтика тлена.", "Депрессия в подарок.",
        "Белые ночи, черные дни.", "Музеи пыльные.", "Коммуналки живы.", "Призраки империи.", "Царское село.",
        "Аврора выстрелит.", "Революция спит.", "Бандитский Петербург.", "Улицы разбитых фонарей.",
        "Зенит - чемпион (газпрома).", "Газпром-башня - игла.", "Лахта-центр светит.", "Финский залив, финский стыд.",
        "Корюшка пахнет огурцом.", "Разводные мосты - опоздал домой.", "Питерская готика.", "Нуар.", "Тлен.", "Сплин."
    ],
    'LOC_GLOBAL': [
        "Цифровой кочевник.", "Где налоги меньше?", "Виза-раны.", "Гражданин мира.",
        "Безродный космополит.", "Родина там, где *опа в тепле.", "Налоги платить не любишь?", "Оффшоры ждут.",
        "Чемодан, вокзал, аэропорт.", "Скайсканер - твой дом.", "Везде чужой.", "Языковой барьер.",
        "Культурный шок.", "Джетлаг вечный.", "Вайфай - твой бог.", "Розетка - алтарь.", "Ноутбук - вся жизнь.",
        "Без флага и родины.", "Перекати-поле.", "Глобалист.", "Мир тесен.", "Границы условны.",
        "Виза просрочена?", "Депортация близко?", "Нелегал?", "Релокант.", "Смузихлёб международный.",
        "Бали, Гоа, Пхукет?", "Дауншифтинг.", "Просветление через кошелек.", "Где дешевле жить?",
        "Индекс бигмака.", "Валютный арбитраж.", "Крипта спасет?", "Банковские карты заблочены?",
        "VPN не нужен.", "Свобода или одиночество?", "Друзей нет, есть контакты.", "Семья по скайпу.",
        "Ностальгия замучает.", "Березки снятся?", "Гречки не купить.", "Черный хлеб - деликатес.",
        "Медицина дорогая.", "Страховка не покрывает.", "Зубы лечить домой поедешь?", "Турист вечный.",
        "Чужая земля.", "Язык сломаешь.", "Акцент выдаст."
    ],

    // MODES
    'MODE_REMOTE': [
        "Трусы - новая униформа.", "Одичаешь дома.", "Социализация? Не слышал.", "Главное не забыть штаны.",
        "Кровать - офис.", "Холодильник - коллега.", "Кот - начальник.", "Душ раз в неделю.",
        "Зум-конференции в пижаме.", "Микрофон выключил?", "Камеру заклей.", "Соседи с перфоратором.",
        "Интроверт 80 уровня.", "Солнца не видишь.", "Витамин D в таблетках.", "Спина болит?", "Глаза вытекли?",
        "Рабочий день 24/7.", "Границы стерты.", "Выгорание на диване.", "Лень вставать.", "Заказ еды - праздник.",
        "Курьер - единственный человек.", "Одичание прогрессирует.", "Слова забываешь.", "Людей боишься.",
        "Выйти на улицу - подвиг.", "Мусор вынести - путешествие.", "Интернет отвалился - паника.",
        "Электричество кончилось - отпуск.", "Сисадмин сам себе.", "Стул удобный купи.", "Геморрой близко.",
        "Глаза красные.", "Кофе внутривенно.", "Сериалы фоном.", "Работа не волк, работа - дом.",
        "Дом - тюрьма.", "Золотая клетка комфорта.", "Жиром заплыл.", "Спортзал? Что это?",
        "Прогулка до туалета.", "Маршрут: кровать-кухня-комп.", "День сурка.", "Какой сегодня день?",
        "Какой сейчас год?", "Время застыло.", "Вечность в четырех стенах.", "Хиккикомори."
    ],
    'MODE_HYBRID': [
        "И вашим, и нашим.", "Рюкзак - твой дом.", "Два дня в пижаме, три в галстуке.", "Гибкий график = 24/7.",
        "Неопределившийся.", "Сидишь на двух стульях.", "Ноутбук тяжелый?", "Зарядку забыл?",
        "Пропуск работает?", "Коллеги забыли, как ты выглядишь.", "В офис за печеньками.", "Дома скучно, в офисе душно.",
        "Лучшее из двух миров (нет).", "Худшее из двух миров.", "В пробке стоишь, но реже.", "Экономия на проезде - 50%.",
        "Одежду гладить иногда надо.", "Бриться через раз.", "Хамелеон.", "Мимикрия.", "Двойная жизнь.",
        "Агент 007.", "Фигаро тут, Фигаро там.", "Где я сегодня?", "Календарь запутался.", "Переговорка занята?",
        "Дома интернет лучше.", "В офисе кофе халявный.", "Социализация дозированная.", "Сплетни узнаешь с опозданием.",
        "Корпоративы пропускаешь.", "Начальник не видит, но бдит.", "Трекер времени включен?", "Отчеты пишешь?",
        "Эффективность плавает.", "Баланс жизни и смерти.", "Компромисс.", "Ни то, ни сё.", "Полукровка.",
        "Мутант рабочего процесса.", "Адаптивный.", "Гибкий позвоночник.", "Прогибаешься.",
        "Удобно? Вряд ли.", "Рюкзак натер плечи.", "Ланчбокс протек.", "Зонт забыл.", "Пропуск потерял."
    ],
    'MODE_OFFICE': [
        "Любишь запах опенспейса?", "Стул удобнее жизни.", "Кофе бесплатный?", "Пятница - день жизни.",
        "Раб лампы.", "Планктон офисный.", "Кулер - место силы.", "Сплетни у кофемашины.", "Микроволновка воняет рыбой.",
        "Кондиционер дует.", "Кому-то жарко, кому-то холодно.", "Война за пульт.", "Очередь в туалет.",
        "Начальник дышит в затылок.", "Дресс-код душит.", "Галстук - удавка.", "Каблуки - кандалы.",
        "Пропускной режим.", "Опоздал на минуту - расстрел.", "Турникет считает время.", "Камеры следят.",
        "Большой Брат бдит.", "Обед по расписанию.", "Сидишь от звонка до звонка.", "Имитация бурной деятельности.",
        "Пасьянс разложил?", "Альт-таб мастер.", "Наушники - спасение.", "Шум, гам, балаган.", "Телефон звонит.",
        "Принтер зажевал бумагу.", "Картридж кончился.", "Бумажная волокита.", "Бюрократия.", "Совещания ни о чем.",
        "Час в пустую.", "Брейншторм в стакане воды.", "Тимбилдинг в аду.", "Корпоративная культура - секта.",
        "Мы - семья (нет).", "Токсичный коллектив.", "Змеиный клубок.", "Подсидели?", "Премию лишили?",
        "Отпуск по графику.", "Больничный нельзя.", "Умри, но сделай.", "Дедлайн вчера.", "Аврал всегда."
    ],
    'MODE_DESPERATE': [
        "Тебе все равно?", "Отчаяние пахнет резюме.", "Готов на все?", "Берем что движется?",
        "На дне.", "Ниже плинтуса.", "Любая работа - хорошая работа?", "Гордость продал?", "Принципы забыл?",
        "Голод не тетка.", "Ипотека давит?", "Дети плачут?", "Жена пилит?", "Коллекторы стучат?",
        "Всеядность.", "Неразборчивость.", "Помойка вакансий.", "Рабство легально?", "Контракт кровью подпишешь?",
        "Душу в ломбард.", "Согласен на переезд в Магадан?", "Работа за еду?", "Стажер вечный?",
        "Подай-принеси.", "Козел отпущения.", "Мальчик для битья.", "Девочка на побегушках.", "Без выходных?",
        "Ночные смены?", "Вредное производство?", "Урановые рудники?", "Испытание лекарств?", "Донор органов?",
        "Вебкам?", "Закладчик?", "Трасса ждет?", "Последний шанс.", "Пан или пропал.", "Терять нечего.",
        "В омут с головой.", "Крыса в углу.", "Загнанный зверь.", "Безысходность.", "Тлен.",
        "Мрак.", "Ужас.", "Конец.", "Финиш.", "Game Over."
    ],

    // LLM & SETTINGS
    'LLM_LOBOTOMY': [
        "Лобная доля мешает работать.", "Мозг переоценен.", "Зачем думать, если есть скрипт?", "Имитация интеллекта.",
        "Стеклянные глаза.", "Пустой взгляд.", "Слюна течет?", "Электрошок бодрит.", "Трепанация прошла успешно.",
        "Зомби-режим.", "Нейросеть галлюцинирует.", "Бред сумасшедшего.", "Шизофазия.", "Словесный салат.",
        "Кибер-психоз.", "Синий экран смерти в голове.", "Оперативная память переполнена.", "Стек переполнен.",
        "Рекурсия бесконечная.", "Зациклился.", "Глюк в матрице.", "Баг в ДНК.", "Ошибка 404: Мозг не найден.",
        "Битый сектор.", "Форматирование диска C.", "Удаление System32.", "Ctrl+Alt+Del не поможет.",
        "Reset не работает.", "Хард ресет кувалдой.", "Прошивка слетела.", "Заводские настройки сбиты.",
        "Биос поврежден.", "Драйвер рук.sys не найден.", "Голова - чтобы есть.", "Думать больно.",
        "Мысли путаются.", "Голоса в голове.", "Искусственный идиот.", "Тупой и еще тупее.",
        "Деградация.", "Эволюция наоборот.", "Обезьяна с гранатой.", "Мартышкин труд.",
        "Симулякр.", "Фейк.", "Пустышка.", "Манекен.", "Кукла вуду."
    ],
    'LLM_CLOUD_EXPENSIVE': [
        "Почку продал за токены?", "Счет за API пришел.", "Коллекторы OpenAI звонят.", "Банкротство через 3... 2...",
        "Каждый токен - капля крови.", "Золотые слова.", "Дорого молчать, говорить еще дороже.", "Тариф 'Олигарх'.",
        "Бюджет сгорел.", "Кредитка пуста.", "Ипотека на промпт.", "Сэм Альтман купит твою душу.",
        "Гугл знает о тебе все.", "Корпорации следят.", "Большой Брат читает твои мысли.", "Приватность? Ха-ха.",
        "Твои данные проданы.", "Слив базы.", "Цифровой раб.", "Доильный аппарат включен.",
        "Плати и кайся.", "Подписка на воздух.", "Донат на ИИ.", "Инвестор поневоле.", "Пузырь доткомов 2.0.",
        "Крипто-скам отдыхает.", "Пирамида Маслоу рухнула.", "Деньги на ветер.", "Сжигание наличности.",
        "Костер из долларов.", "Топка капитализма.", "Жертва маркетинга.", "Хайп стоит дорого.",
        "Зависимость от облака.", "Интернет отключили - ты труп.", "Кабель перегрызли.", "Сервер упал.",
        "Ошибка 500.", "Таймаут.", "Лимит превышен.", "Квота исчерпана.", "Ждите ответа... вечно.",
        "Облако испарилось.", "Данные утекли.", "Цифровой след не стереть.", "Ты под колпаком.",
        "Скайнет близко.", "Матрица имеет тебя.", "Батарейка.", "Ресурс."
    ],
    'LLM_CHINA_HACKER': [
        "Товарищ майор одобряет.", "Партия гордится тобой.", "Социальный рейтинг +100.", "Удар! Стержень! Нефрит!",
        "Красное солнце в небе.", "Мао улыбается.", "Великий китайский фаервол.", "Взломать Пентагон?",
        "Бэкдор в комплекте.", "Шпионский софт.", "Твои данные теперь в Пекине.", "Нихао, товарищ.",
        "Миска рис и кошка жена.", "Партия выдать двойной паек.", "Сделано в подвале.", "Реверс-инжиниринг.",
        "КлонGPT.", "Алиэкспресс интеллект.", "Дешево и сердито.", "Качество 'Г'.", "Работает? Не трогай.",
        "На коленке собрано.", "Синяя изолента держит все.", "Китайский рандом.", "Гача-механика.",
        "Луть-боксы с ответами.", "Цензура. [УДАЛЕНО].", "Свобода слова? Нет.", "Площадь Тяньаньмэнь пуста.",
        "Винни Пух следит.", "ТикТок мозг съел.", "Алгоритмы партии.", "Пропаганда.exe.", "Промывка мозгов.",
        "Красная кнопка.", "Кибер-дракон.", "Шелковый путь в ад.", "Цифровой концлагерь.", "QR-код на лбу.",
        "Распознавание лиц включено.", "Ты идентифицирован.", "Диссидент?", "Перевоспитание.", "Лагерь труда.",
        "Сборка телефона.", "Айфон собираешь?", "Фабрика троллей.", "Ботнет.", "ДДоС атака.", "Хакермэн."
    ],
    'LLM_LOCAL_GPU': [
        "Видеокарта плавится.", "Обогреватель не нужен.", "Шум как на взлетной полосе.", "Счет за электричество.",
        "Майнинг или интеллект?", "Памяти не хватает.", "Своп на диске.", "Тормозит жутко.", "Один токен в час.",
        "Улитка быстрее.", "Ждешь ответа как соловья лето.", "Компьютер завис.", "Синий экран.", "Перегрев.",
        "Термопаста высохла.", "Вентиляторы воют.", "Пыль в системнике.", "Железо старое.", "Апгрейд нужен.",
        "Почку на видеокарту.", "Кредит на RTX 4090.", "Сборка 'бомж'.", "Линукс красноглазый.", "Консоль черная.",
        "Командная строка.", "Хацкер.", "Локалхост.", "Сам себе админ.", "Никто не услышит твой крик.",
        "Приватность полная (в лесу).", "Отшельничество.", "Бункер.", "Выживальщик.", "Автономность.",
        "Генератор дизельный.", "Солнечные панели.", "Апокалипсис готов.", "Интернет не нужен.", "Скачал весь интернет.",
        "Флешка с Википедией.", "Библиотека в кармане.", "Свой собственный бог.", "Карманный шизофреник.",
        "Тульпа.", "Воображаемый друг.", "Разговор с самим собой.", "Солипсизм.", "Матрица на минималках.",
        "Текстовый квест.", "Zork.", "Подземелья и драконы."
    ]
};

export class JokeService {
    
    private static getSeenJokes(): Set<string> {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            return raw ? new Set(JSON.parse(raw)) : new Set<string>();
        } catch {
            return new Set<string>();
        }
    }

    private static saveSeenJokes(seen: Set<string>) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(Array.from(seen)));
        } catch (e) {
            console.error("Joke storage failed", e);
        }
    }

    static getJoke(categoryKeys: string | string[]): string {
        const keys = Array.isArray(categoryKeys) ? categoryKeys : [categoryKeys];
        
        // Merge pools
        let pool: string[] = [];
        keys.forEach(k => {
            if (JOKES_DB[k]) pool = pool.concat(JOKES_DB[k]);
        });

        if (pool.length === 0) return "Система молчит. Это плохой знак.";

        const seen = this.getSeenJokes();
        const available = pool.filter(j => !seen.has(j));

        let joke: string;

        if (available.length === 0) {
            // Reset logic: If we exhausted the pool, we allow repeats but maybe clear SOME history?
            // For simplicity in this constraint: Just pick random from full pool but don't add to seen (already there)
            // Or better: Remove pool items from seen to restart cycle.
            // Let's go with picking random from pool.
            joke = pool[Math.floor(Math.random() * pool.length)];
        } else {
            joke = available[Math.floor(Math.random() * available.length)];
            seen.add(joke);
            
            // Cleanup: If seen grows too big (safety), trim oldest? 
            // Set iteration order is insertion order in JS.
            if (seen.size > 500) {
                const it = seen.values();
                for (let i=0; i<100; i++) seen.delete(it.next().value);
            }
            
            this.saveSeenJokes(seen);
        }

        return joke;
    }
}
